FigureYa245VarDecompose_update
FigureYa245VarDecompose_update
Author(s)
: Jianing Gao
Reviewer(s)
: Ying Ge, Hui Huang
Date
: 2025-11-18
Academic Citation
If you use this code in your work or research, we kindly request that
you cite our publication:
Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization
Framework for Enhancing Biomedical Data Interpretation and Research
Efficiency. iMetaMed.
https://doi.org/10.1002/imm3.70005
需求描述 Requirement Description
我想实现这篇文献的Fig.2b，使用RNA-seq来衡量基因的表达保守性。
基因在物种之间表达量的保守性，想用来分析非编码RNA在不同物种之间的表达保守性。
I would like to draw Fig.2b of this article, using RNA-seq to measure
the conserved expression of genes.
The conservation of gene expression between species was intended to
analyze the expression conservation of non-coding RNAs between
species.
From
https://www.nature.com/articles/nature13992
Figure 2: Comparative analysis of the gene expression programs in
human and mouse samples.
b, Gene expression variance decomposition (see Methods) estimates the
relative contribution of tissue and species to the observed variance in
gene expression for each orthologous human–mouse gene pair. Green dots
indicate genes with
higher between-tissue contribution
and red dots genes with
higher between-species
contributions
.
Our initial analyses revealed that gene expression patterns tended to
cluster more by species rather than by tissue (Fig. 2a). To resolve the
sets of genes contributing to different components in the clustering, we
employed variance decomposition (see Methods) to estimate, for each
orthologous human–mouse gene pair, the proportion of the variance in
expression that is contributed by tissue and by species (Fig. 2b). This
analysis revealed the sets of genes
whose expression varies more
across tissues than between species
, and those
whose
expression varies more between species than across tissues
. As
expected,
the clustering of the RNA-seq samples is dominated
either by species or tissues
, depending on the gene set
employed (Extended Data Fig. 1a, b). Furthermore, removal of the ~4,800
genes that drive the species-specific clustering (see ref. 47,
Supplementary Fig. 1d therein) or normalization methods that reduce the
species effects reveal tissue-specific patterns of expression in the
same samples (Extended Data Fig. 1c).
作者通过对人和鼠10个不同的组织的转录组数据通过PCA（Fig.2a，画法可参考FigureYa101PCA）评估了基因表达在人鼠之间的保守性，发现样本主要按照物种而不是组织分开，这表明人鼠之间的基因表达差异大于组织之间的差异。随后作者通过方差分解（线性混合模型）计算了组织和物种对基因表达方差的贡献，鉴定出了人鼠表达保守和人鼠表达差异的基因（Fig.2b）。在剔除了人鼠表达差异的基因后，PCA的结果表明样本按照组织而不是物种分布（Extend
Fig.1c）。
The authors evaluated the conservation of gene expression between
humans and mice by PCA (Fig.2a, see FigureYa101PCA) on transcriptome
data from 10 different tissues of humans and mice, and found that the
samples were mainly separated by species rather than tissues, indicating
that the differences in gene expression between humans and mice were
greater than the differences between tissues. The authors then
calculated the contribution of tissues and species to the variance of
gene expression by variance decomposition (linear mixed model) and
identified genes with conservative human-mouse expression and
differential human-mouse expression (Fig.2b). After culling the
differentially expressed genes in humans and mice, the results of PCA
showed that the samples were distributed by tissue rather than species
(Extend Fig.1c).
应用场景 Application Scenarios
Fig.2b的方法具有普适性，对于研究某基因在物种之间表达的保守性有指导意义。如果某基因的表达水平在人鼠之间不保守，可能提示着该基因突变造成的效应在人鼠之间有差异。此时运用小鼠作为模式生物得到的结论泛化到人上时，需要特别谨慎。
Fig.2b’s method is universal and has guiding significance for
studying the conserved expression of a gene between species. If the
expression level of a gene is not conserved between humans and mice, it
may indicate that the effects of the gene mutation are different between
humans and mice. At this point, special caution is required when
generalizing conclusions from mice as model organisms to humans.
original text：Categorizing orthologous gene pairs into these groups
should enable more informative translation of research results between
mouse and human. In particular, for
gene pairs whose variance in
expression is largest between tissues (and less between species), mouse
should be a particularly informative model for human biology
.
In contrast, interpretation of studies involving
genes whose
variance in expression is larger between species needs to take into
account the species variation
. The relative contributions of
species-specific and tissue-specific factors to each gene’s expression
are further explored in two associated papers37,47.
本脚本主要实现了以下功能：
按照直系同源关系（one2one orthologs）合并人鼠转录组
数据重构，使之方便应用线性混合模型
利用并行计算批量对每个基因构建线性混合模型，并计算物种和组织两个随机效应分别对基因表达方差的贡献
绘图，复现Fig.2b
This script implements the following functions:
Merge the human and mouse transcriptomes according to the
orthologous relationship (one2one orthologs).
Data reconstruction to facilitate the application of linear hybrid
models
Parallel computational batches were used to construct a linear mixed
model for each gene, and the contribution of two random effects, species
and tissue, to the variance of gene expression was calculated
Drawing, reproduction Fig.2b
环境设置 Environment settings
source("install_dependencies.R")
library(tidyverse)      # 用于数据操作和可视化的包 # For data manipulation and visualization
library(lme4)           # 用于实现线性混合模型 (LMM) 的包 # Used to implement linear mixed model (LMM)
library(doParallel)     # 用于并行计算的包 # For parallel computing
library(ggrepel)        # 用于防止标签重叠的智能标注 # Smart label repulsion to avoid overlaps
Sys.setenv(LANGUAGE = "en")  # 显示英文报错信息 # Display error messages in English
options(stringsAsFactors = FALSE)  # 禁止字符型数据自动转换为因子型 # Prevent automatic conversion of character data to factors
输入文件 Input files
human.tissue.fpkm.rds和mouse.tissue.fpkm.rds，人和鼠各器官的表达矩阵。
mart_export.txt，人和鼠同源基因的对应关系。
human.tissue.fpkm.rds and mouse.tissue.fpkm.rds, expression matrices
of human and mouse organs.
mart_export.txt, correspondence between human and mouse homologous
genes.
# 在结果中搜索你的目标基因 Search for your target gene in the results
highlight_pattern <- "^fox[a-zA-Z][0-9]" # 以FoxA1, FoxB1, FoxC2等基因为例

#highlight_genes <- c("EMC10_Emc10", "LRRIQ3_Lrriq3")  # 自定义待关注基因关键词（支持正则或多个关键词）
#highlight_pattern <- paste(highlight_genes, collapse = "|") # 两个基因对

# 加载表达矩阵
# Load the Expression Matrix
human <- readRDS("human.tissue.fpkm.rds")
#如果你的数据是csv格式，可以这样读取
# If your data is in csv format, you can read it like this
#human <- read.csv("human.tissue.fpkm.csv")
mouse <- readRDS("mouse.tissue.fpkm.rds")

# 加载同源基因对应关系
# Load homologous gene correspondence
# 新文件格式：CSV格式，列名为 "Mouse gene name" 和 "Gene name"（人类基因名称）
# New file format: CSV format with column names "Mouse gene name" and "Gene name" (human gene name)
orthologs <- read.csv("mart_export.txt", stringsAsFactors = FALSE)
# 重命名列以便后续使用 / Rename columns for later use
colnames(orthologs) <- c("Mouse_gene_name", "Human_gene_name")
# 移除空行 / Remove empty rows
orthologs <- orthologs[!is.na(orthologs$Mouse_gene_name) & orthologs$Mouse_gene_name != "", ]
# 移除重复项 / Remove duplicates
orthologs <- orthologs[!duplicated(orthologs), ]
cat("加载的同源基因对数量 / Number of orthologous gene pairs loaded:", nrow(orthologs), "\n")
Filter genes:
Genes with a maximum RPKM greater than 0.1 in each dataset were
kept.
kept.rows <- apply(human[, -c(1,2)], 1, max) > 0.1
table(kept.rows)
human <- human[kept.rows, ]
kept.rows <- apply(mouse[, -c(1,2)], 1, max) > 0.1
table(kept.rows)
mouse <- mouse[kept.rows, ]
1) 按照直系同源关系(one2one orthologs)合并人鼠转录组
1) Merge human-mouse transcriptomes according to orthologous
relationships (one2one orthologs).
# 统计原始同源基因对数量 / Count original orthologous gene pairs
cat("原始同源基因对数量 / Original number of orthologous gene pairs:", nrow(orthologs), "\n")
# 使用基因名称匹配（新文件格式使用基因名称而非Ensembl ID）
# Match using gene names (new file format uses gene names instead of Ensembl IDs)
in.human <- orthologs$Human_gene_name %in% human$Gene.Name
in.mouse <- orthologs$Mouse_gene_name %in% mouse$Gene.Name
# 取人鼠的转录组都检测到的同源基因对
# Take orthologous gene pairs detected in both human and mouse transcriptomes
orthologs <- orthologs[in.human & in.mouse, ]

# 统计筛选后的同源基因对数量 / Count filtered orthologous gene pairs
cat("筛选后同源基因对数量（在人鼠转录组中都检测到的） / Filtered number of orthologous gene pairs (detected in both human and mouse transcriptomes):", nrow(orthologs), "\n")
# 检查orthologs中是否有重复的基因名称 / Check for duplicate gene names in orthologs
duplicate_human <- duplicated(orthologs$Human_gene_name) | duplicated(orthologs$Human_gene_name, fromLast = TRUE)
duplicate_mouse <- duplicated(orthologs$Mouse_gene_name) | duplicated(orthologs$Mouse_gene_name, fromLast = TRUE)
if (any(duplicate_human) || any(duplicate_mouse)) {
  cat("警告：发现重复的同源基因对，将只保留第一个 / Warning: Duplicate orthologous gene pairs found, keeping only the first occurrence\n")
  orthologs <- orthologs[!duplicated(orthologs$Human_gene_name) & !duplicated(orthologs$Mouse_gene_name), ]
  cat("去重后的同源基因对数量 / Number of orthologous gene pairs after deduplication:", nrow(orthologs), "\n")
}
# 使用基因名称筛选数据 / Filter data using gene names
human <- human %>% filter(Gene.Name %in% orthologs$Human_gene_name)
mouse <- mouse %>% filter(Gene.Name %in% orthologs$Mouse_gene_name)

# 检查human和mouse中是否有重复的基因名称 / Check for duplicate gene names in human and mouse data
if (any(duplicated(human$Gene.Name))) {
  cat("警告：human数据中有重复的基因名称，将只保留第一个 / Warning: Duplicate gene names in human data, keeping only the first occurrence\n")
  human <- human[!duplicated(human$Gene.Name), ]
}
if (any(duplicated(mouse$Gene.Name))) {
  cat("警告：mouse数据中有重复的基因名称，将只保留第一个 / Warning: Duplicate gene names in mouse data, keeping only the first occurrence\n")
  mouse <- mouse[!duplicated(mouse$Gene.Name), ]
}
# 确保human和mouse数据按照同源关系对齐 / Ensure human and mouse data are aligned by orthologous relationship
# 按照orthologs的顺序排序 / Sort according to orthologs order
human <- human[match(orthologs$Human_gene_name, human$Gene.Name), ]
mouse <- mouse[match(orthologs$Mouse_gene_name, mouse$Gene.Name), ]

# 移除匹配失败的NA行 / Remove NA rows from failed matches
human <- human[!is.na(human$Gene.Name), ]
mouse <- mouse[!is.na(mouse$Gene.Name), ]
# 更新orthologs以匹配实际匹配成功的基因对 / Update orthologs to match successfully matched gene pairs
orthologs <- orthologs[orthologs$Human_gene_name %in% human$Gene.Name & orthologs$Mouse_gene_name %in% mouse$Gene.Name, ]

all(dim(human) == dim(mouse)) # should be TRUE
cat("最终用于分析的同源基因对数量 / Final number of orthologous gene pairs for analysis:", nrow(orthologs), "\n")
colnames(human) <- paste0("Human_", colnames(human))
colnames(mouse) <- paste0("Mouse_", colnames(mouse))

# Order by orthologs (using gene names now)
# 使用行号作为行名，避免重复基因名称的问题 / Use row numbers as row names to avoid duplicate gene name issues
rownames(human) <- paste0("Human_", seq_len(nrow(human)))
rownames(mouse) <- paste0("Mouse_", seq_len(nrow(mouse)))
# 按照orthologs的顺序重新排序 / Reorder according to orthologs order
human <- human[match(orthologs$Human_gene_name, human$Human_Gene.Name), ] %>% as_tibble()
mouse <- mouse[match(orthologs$Mouse_gene_name, mouse$Mouse_Gene.Name), ] %>% as_tibble()
data <- cbind(human, mouse)
2) 数据重构，使之方便应用线性混合模型
2) Data reconstruction to facilitate the application of linear
hybrid models
data <- data %>% 
  mutate(GenePairs = paste(Human_Gene.Name, Mouse_Gene.Name, sep = "_"), .before = 1) %>% 
  select(-contains("Gene.")) %>% 
  pivot_longer(-GenePairs,
               names_to = c("Species", "Tissue"), 
               names_sep = "_", 
               values_to = c("FPKM"))
We used log10 (RPKM) to normalize the data and a pseudocount of 0.01
to deal with zero expression values.
data$lgFPKM <- log10(data$FPKM + 0.01)
data$Tissue <- factor(data$Tissue) # Tissue should be factor for LMM model
data$Species <- factor(data$Species) # Species should be factor for LMM model 
head(data)
3)
批量对每个基因构建线性混合模型(LMM)，并计算物种和组织两个随机效应分别对基因表达方差的贡献
3) Construct a linear mixed model (LMM) for each gene in batches,
and calculate the contribution of two random effects of species and
tissue to gene expression variance, respectively
Gene expression was modeled as a function of tissue and the species
(considered as random factors).
The LMM was implemented in the R package lme4 (ref).
The restricted maximum likelihood (REML) estimators for the random
effects of
tissue, species and residual
variance were
normalized by their sum to give the variance components (Fig. 2b).
根据原文描述，LMM模型应该如下: According to the original description,
the LMM model should look like this:
logFPKM ~ 1 + (1|Tissue) + (1|Species)
|Dependent variable| |Random Effects (Intercept)| |Random Effects 2
(Intercept)|
这里提供两种计算方式，“串行计算”慢，推荐找个服务器运行“并行运算”。
There are two computing methods here, “serial computing” is slow, it is
recommended to find a server to run “parallel computing”.
串行计算：大约15min
Serial calculation: about 15min
gene.pairs <- unique(data$GenePairs)

lmm.var.dcp <- pbapply::pblapply(gene.pairs, function(xx) {
  model <- lmer(lgFPKM~1+(1|Tissue)+(1|Species), data = subset(data, GenePairs == xx), REML = TRUE, verbose = FALSE)
  results <- as.data.frame(VarCorr(model))
  res <- results$vcov / sum(results$vcov) # normalized by their sum to give the variance components
  data.frame(
    GenePairs = xx,
    frac.of.var.tissue = res[1],
    frac.of.var.species = res[2],
    frac.of.var.residual = res[3]
  )
}) %>% do.call(rbind, .)
并行计算(推荐)
Parallel Computing (Recommended)
gene.pairs <- unique(data$GenePairs)

lmm.var.dcp <- foreach(
  xx = gene.pairs, 
  .combine = "rbind", 
  .packages = c("lme4"),
  .export = c("data")) %dopar% {
    model <- lmer(lgFPKM~1+(1|Tissue)+(1|Species), data = subset(data, GenePairs == xx), REML = TRUE, verbose = FALSE)
    results <- as.data.frame(VarCorr(model))
    res <- results$vcov / sum(results$vcov)
    data.frame(
      GenePairs = xx,
      frac.of.var.tissue = res[1],
      frac.of.var.species = res[2],
      frac.of.var.residual = res[3]
    )
  }

head(lmm.var.dcp)
# 输出到文件，便于查看和选择自己感兴趣的基因
# Export to a file for easy viewing and selection of genes of interest
write.csv(lmm.var.dcp, "output_lmm.var.dcp.csv", quote = F, row.names = F)

# 生成带分组信息的CSV文件（用于FigureYa245Plus_VarDecompose）
# Generate CSV file with group information (for FigureYa245Plus_VarDecompose)
cat("生成带分组信息的CSV文件...\n")
# 计算分位数 / Calculate quantiles
top.quantile.tissue <- quantile(lmm.var.dcp$frac.of.var.tissue)[4]
top.quantile.species <- quantile(lmm.var.dcp$frac.of.var.species)[4]

# 添加group列 / Add group column
lmm.var.dcp.with.groups <- lmm.var.dcp %>% 
  mutate(group = ifelse(
    frac.of.var.tissue > top.quantile.tissue & 
      frac.of.var.tissue > frac.of.var.species, "High across tissues", 
    ifelse(
      frac.of.var.species > top.quantile.species & 
        frac.of.var.species > frac.of.var.tissue, "High across species", "None")
  ))

# 统计各组的数量 / Count genes in each group
cat("各组数量统计 / Group statistics:\n")
print(table(lmm.var.dcp.with.groups$group))
# 保存到FigureYa245Plus_VarDecompose目录 / Save to FigureYa245Plus_VarDecompose directory
output_file <- "../FigureYa245Plus_VarDecompose/lmm_var_dcp_with_groups.csv"
write.csv(lmm.var.dcp.with.groups, output_file, quote = FALSE, row.names = FALSE)
cat("文件已保存到 / File saved to:", output_file, "\n")
cat("文件行数 / Number of rows:", nrow(lmm.var.dcp.with.groups), "\n")
开始画图 - Fig.2b
Start Drawing - Fig.2b
lmm.var.dcp <- readRDS("lmm.var.dcp.rds")

(top.quantile.tissue <-  quantile(lmm.var.dcp$frac.of.var.tissue)[4])
(top.quantile.species <- quantile(lmm.var.dcp$frac.of.var.species)[4])
lmm.var.dcp %>% 
  mutate(group = ifelse(
    frac.of.var.tissue > top.quantile.tissue & 
      frac.of.var.tissue > frac.of.var.species, "High across tissues", 
    ifelse(
      frac.of.var.species > top.quantile.species & 
        frac.of.var.species > frac.of.var.tissue, "High across species", "None")
  )) %>% 
  ggplot(aes(frac.of.var.tissue, frac.of.var.species, color = group)) + 
  geom_point(size = 0.5) + 
  guides(color = guide_legend(override.aes = list(size = 3))) + 
  theme_bw(base_size = 15) + 
  labs(x = "Fraction of variance across tissues", 
       y = "Fraction of variance\nacross species") + 
  theme(
    panel.grid = element_blank(),
    legend.title = element_blank(),
    legend.position = c(0.7, 0.85),
    legend.background = element_blank(),
    axis.text = element_text(color = "black")
  )
ggsave("VarDecompose.pdf")
在图中标出感兴趣的基因
# 修改的绘图代码
lmm.var.dcp %>% 
  mutate(group = ifelse(
    frac.of.var.tissue > top.quantile.tissue & 
      frac.of.var.tissue > frac.of.var.species, "High across tissues", 
    ifelse(
      frac.of.var.species > top.quantile.species & 
        frac.of.var.species > frac.of.var.tissue, "High across species", "None")
  )) %>% 
  # 标记包含关键词的基因对（默认 fox，可按需调整）
  mutate(is_highlight = grepl(highlight_pattern, GenePairs, ignore.case = TRUE)) %>%
  ggplot(aes(frac.of.var.tissue, frac.of.var.species, color = group)) + 
  geom_point(size = 0.5) + 
  # 添加包含关键词的基因对的标注
  geom_point(data = . %>% filter(is_highlight), 
             aes(frac.of.var.tissue, frac.of.var.species), 
             color = "black", size = 2, shape = 21, fill = "yellow", stroke = 1) +
  # 添加文本标签
  geom_text_repel(data = . %>% filter(is_highlight),
                  aes(label = GenePairs), 
                  color = "black", 
                  size = 4,
                  fontface = "bold",
                  box.padding = 0.5,
                  point.padding = 0.5) +
  guides(color = guide_legend(override.aes = list(size = 3))) + 
  theme_bw(base_size = 15) + 
  labs(x = "Fraction of variance across tissues", 
       y = "Fraction of variance\nacross species") + 
  theme(
    panel.grid = element_blank(),
    legend.title = element_blank(),
    legend.position = c(0.7, 0.85),
    legend.background = element_blank(),
    axis.text = element_text(color = "black")
  )
ggsave("VarDecompose_gene.pdf")
顺便看两个同源基因
By the way, look at the two homologous genes
在人鼠之间基因表达水平相对保守的基因
Genes with relatively conserved gene expression levels between
humans and mice
分别画图看一下人鼠之间基因表达水平相对保守/有差异的基因
Draw separate graphs to see genes with relatively
conserved/differential gene expression levels between humans and
mice
Example of genes with higher between-tissue contribution
subset(lmm.var.dcp, GenePairs=="FOXL1_Foxl1") # or LRRIQ3_Lrriq3
data %>% filter(GenePairs=="FOXL1_Foxl1") %>% 
  ggplot(aes(Tissue, lgFPKM, color=Species)) + 
  geom_point() + 
  geom_text(aes(label=Tissue))
在人鼠之间基因表达水平有差异的基因
Genes with differential gene expression levels between humans and
mice
Example of genes with higher between-species contribution
subset(lmm.var.dcp, GenePairs=="FOXK2_Foxk2") # or EMC10_Emc10
data %>% filter(GenePairs=="FOXK2_Foxk2") %>% 
  ggplot(aes(Tissue, lgFPKM, color=Species)) + 
  geom_point() + 
  geom_text(aes(label=Tissue))
效果还挺明显 The effect is quite obvious
组织效应和物种效应都不显著的基因
Genes with insignificant tissue and species effects
subset(lmm.var.dcp, GenePairs=="FOXO3_Foxo3")
data %>% filter(GenePairs=="FOXO3_Foxo3") %>% 
  ggplot(aes(Tissue, lgFPKM, color=Species)) + 
  geom_point() + 
  geom_text(aes(label=Tissue))
Session Info
sessionInfo()