<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PWAåŠŸèƒ½æµ‹è¯• - Nomogram Calculator</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PWAæµ‹è¯•">
    <link rel="apple-touch-icon" href="images/icon-192.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196f3">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .test-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            background: #f9f9f9;
        }
        .test-item.success {
            border-left-color: #4caf50;
            background: #f1f8e9;
        }
        .test-item.error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .test-item.info {
            border-left-color: #2196f3;
            background: #e3f2fd;
        }
        .status {
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        .status.pass { color: #4caf50; }
        .status.fail { color: #f44336; }
        .status.info { color: #2196f3; }
        h1 { color: #2196f3; margin-bottom: 20px; }
        h2 { color: #333; margin: 20px 0 10px 0; }
        .button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        .button:hover { background: #1976d2; }
        .result {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± PWAåŠŸèƒ½æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•Nomogramåº”ç”¨çš„PWAåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>

        <h2>ğŸ” åŸºç¡€æ£€æµ‹</h2>
        <div id="basic-tests"></div>

        <h2>ğŸ“± PWAç‰¹æ€§æ£€æµ‹</h2>
        <div id="pwa-tests"></div>

        <h2>ğŸ iOSç‰¹å®šåŠŸèƒ½</h2>
        <div id="ios-tests"></div>

        <h2>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h2>
        <button class="button" onclick="testServiceWorker()">æµ‹è¯•Service Worker</button>
        <button class="button" onclick="testNotification()">æµ‹è¯•é€šçŸ¥</button>
        <button class="button" onclick="testInstallPrompt()">æµ‹è¯•å®‰è£…æç¤º</button>
        <button class="button" onclick="clearCache()">æ¸…ç†ç¼“å­˜</button>

        <div id="test-results"></div>
    </div>

    <script>
        // åŸºç¡€åŠŸèƒ½æ£€æµ‹
        function runBasicTests() {
            const container = document.getElementById('basic-tests');
            const tests = [
                {
                    name: 'Service Workeræ”¯æŒ',
                    test: () => 'serviceWorker' in navigator
                },
                {
                    name: 'Manifestæ”¯æŒ',
                    test: () => 'onbeforeinstallprompt' in window
                },
                {
                    name: 'é€šçŸ¥æ”¯æŒ',
                    test: () => 'Notification' in window
                },
                {
                    name: 'æœ¬åœ°å­˜å‚¨æ”¯æŒ',
                    test: () => 'localStorage' in window
                },
                {
                    name: 'åœ°ç†å®šä½æ”¯æŒ',
                    test: () => 'geolocation' in navigator
                }
            ];

            tests.forEach(test => {
                const result = test.test();
                const div = document.createElement('div');
                div.className = `test-item ${result ? 'success' : 'error'}`;
                div.innerHTML = `
                    <strong>${test.name}</strong>
                    <span class="status ${result ? 'pass' : 'fail'}">${result ? 'âœ“ é€šè¿‡' : 'âœ— å¤±è´¥'}</span>
                `;
                container.appendChild(div);
            });
        }

        // PWAç‰¹æ€§æ£€æµ‹
        function runPWATests() {
            const container = document.getElementById('pwa-tests');

            // æ£€æµ‹æ˜¾ç¤ºæ¨¡å¼
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                               window.navigator.standalone === true;

            const tests = [
                {
                    name: 'å½“å‰æ˜¾ç¤ºæ¨¡å¼',
                    test: () => isStandalone ? 'ç‹¬ç«‹åº”ç”¨æ¨¡å¼' : 'æµè§ˆå™¨æ¨¡å¼'
                },
                {
                    name: 'å±å¹•æ–¹å‘',
                    test: () => window.orientation || 'æœªçŸ¥'
                },
                {
                    name: 'è®¾å¤‡åƒç´ æ¯”',
                    test: () => window.devicePixelRatio
                },
                {
                    name: 'å±å¹•å°ºå¯¸',
                    test: () => `${window.screen.width}x${window.screen.height}`
                },
                {
                    name: 'ç½‘ç»œè¿æ¥',
                    test: () => navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'
                }
            ];

            tests.forEach(test => {
                const result = test.test();
                const div = document.createElement('div');
                div.className = 'test-item info';
                div.innerHTML = `
                    <strong>${test.name}</strong>
                    <span class="status info">${result}</span>
                `;
                container.appendChild(div);
            });
        }

        // iOSç‰¹å®šåŠŸèƒ½æ£€æµ‹
        function runIOSTests() {
            const container = document.getElementById('ios-tests');
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

            const tests = [
                {
                    name: 'iOSè®¾å¤‡æ£€æµ‹',
                    test: () => isIOS
                },
                {
                    name: 'Safariæµè§ˆå™¨',
                    test: () => /^((?!chrome|android).)*safari/i.test(navigator.userAgent)
                },
                {
                    name: 'å®‰å…¨åŒºåŸŸæ”¯æŒ',
                    test: () => CSS.supports('padding', 'max(0px)')
                },
                {
                    name: 'Web Appæ¨¡å¼',
                    test: () => window.navigator.standalone === true
                },
                {
                    name: 'è§¦æ‘¸æ”¯æŒ',
                    test: () => 'ontouchstart' in window
                }
            ];

            tests.forEach(test => {
                const result = test.test();
                const div = document.createElement('div');
                div.className = `test-item ${result ? 'success' : 'error'}`;
                div.innerHTML = `
                    <strong>${test.name}</strong>
                    <span class="status ${result ? 'pass' : 'fail'}">${result ? 'âœ“ æ”¯æŒ' : 'âœ— ä¸æ”¯æŒ'}</span>
                `;
                container.appendChild(div);
            });
        }

        // æµ‹è¯•Service Worker
        async function testServiceWorker() {
            const resultsDiv = document.getElementById('test-results');

            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        showResult('Service Workerå·²æ³¨å†Œ: ' + registration.scope, 'success');
                        showResult('æ›´æ–°çŠ¶æ€: ' + (registration.active ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'), 'info');
                    } else {
                        showResult('Service Workeræœªæ³¨å†Œ', 'error');
                    }
                } catch (error) {
                    showResult('Service Workeræ£€æµ‹å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                showResult('æµè§ˆå™¨ä¸æ”¯æŒService Worker', 'error');
            }
        }

        // æµ‹è¯•é€šçŸ¥
        async function testNotification() {
            const resultsDiv = document.getElementById('test-results');

            if ('Notification' in window) {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        new Notification('æµ‹è¯•é€šçŸ¥', {
                            body: 'Nomogramåº”ç”¨é€šçŸ¥åŠŸèƒ½æ­£å¸¸',
                            icon: '/images/icon-192.png'
                        });
                        showResult('é€šçŸ¥æƒé™å·²æˆäºˆï¼Œæµ‹è¯•é€šçŸ¥å·²å‘é€', 'success');
                    } else {
                        showResult('é€šçŸ¥æƒé™è¢«æ‹’ç»', 'error');
                    }
                } catch (error) {
                    showResult('é€šçŸ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                showResult('æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½', 'error');
            }
        }

        // æµ‹è¯•å®‰è£…æç¤º
        function testInstallPrompt() {
            const resultsDiv = document.getElementById('test-results');

            if ('beforeinstallprompt' in window) {
                showResult('æµè§ˆå™¨æ”¯æŒPWAå®‰è£…æç¤º', 'success');
            } else if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                showResult('iOSè®¾å¤‡ï¼šéœ€è¦æ‰‹åŠ¨æ·»åŠ åˆ°ä¸»å±å¹•', 'info');
            } else {
                showResult('æµè§ˆå™¨ä¸æ”¯æŒPWAå®‰è£…æç¤º', 'error');
            }
        }

        // æ¸…ç†ç¼“å­˜
        async function clearCache() {
            const resultsDiv = document.getElementById('test-results');

            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    showResult(`å·²æ¸…ç†${cacheNames.length}ä¸ªç¼“å­˜`, 'success');
                } catch (error) {
                    showResult('ç¼“å­˜æ¸…ç†å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                showResult('æµè§ˆå™¨ä¸æ”¯æŒç¼“å­˜API', 'error');
            }
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function showResult(message, type) {
            const resultsDiv = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `test-item ${type}`;
            div.innerHTML = `<span class="status ${type}">${message}</span>`;
            resultsDiv.appendChild(div);
        }

        // é¡µé¢åŠ è½½æ—¶è¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', () => {
            runBasicTests();
            runPWATests();
            runIOSTests();
        });
    </script>
</body>
</html>